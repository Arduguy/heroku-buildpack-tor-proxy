#!/usr/bin/env bash

## VARIABLES
RUN_COMMAND=run_tor
TOR_SRC_NAME=tor-0.3.0.10.tar.gz
TOR_DIST_URL=https://www.torproject.org/dist/


## --

set -x

indent() {
    sed -u 's/^/      /'
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
TOR_SIG_NAME=${TOR_SRC_NAME}.asc
TOR_SRC_URL=${TOR_DIST_URL}${TOR_SRC_NAME}
TOR_SRC_SIG_URL=${TOR_DIST_URL}${TOR_SIG_NAME}



################################################################################
# GET SOURCES
################################################################################
echo "Downloading ${TOR_SRC_URL}"
wget -q $TOR_SRC_URL

if [ $? - ne 0]; then
    echo "FAILED to obtain ${TOR_SRC_URL}" | indent
    exit 1
fi

echo "Downloading ${TOR_SRC_SIG_URL}"
wget -q $TOR_SRC_SIG_URL

if [ $? -ne 0 ]; then
    echo "FAILED to obtain signature ${TOR_SRC_SIG_URL}" | indent
    exit 1
fi

################################################################################
# VERIFY INTEGRITY
################################################################################

gpg --keyserver pool.sks-keyservers.net --recv-keys 0x4E2C6E8793298290
gpg --keyserver pool.sks-keyservers.net --recv-keys 0x6AFEE6D49E92B601
gpg --verify ${TOR_SIG_NAME} ${TOR_SRC_NAME} | grep -c "Good signature"
if [ $? -lt 1 ]; then
    echo "FAILED to verify the signature" | indent
    exit 1
fi

################################################################################
# COMPILE & INSTALL
################################################################################

# Finally do some compilation.
tar -zxf ${TOR_SRC_NAME}
cd tor-*
./configure --prefix=$BUILD_DIR
if [ $? -ne 0 ]; then
    echo "FAILED to configure for compliation" | indent
    exit 1
fi

make install
if [ $? -ne 0 ]; then
    echo "FAILED to run make install" | indent
    exit  1
fi


cat > ${BUILD_DIR}/bin/${RUN_COMMAND} <<EOF
#!/usr/bin/env bash

mkdir -p "${HOME}/hidden_service"

echo "Setting up hidden service"
cat > ${HOME}/hidden_service/private_key <<EPK
\${HIDDEN_PRIVATE_KEY}
EPK
echo \${HIDDEN_DOT_ONION} > ${HOME}/hidden_service/hostname

echo "HiddenServiceDir ${HOME}/hidden_service/" > $HOME/etc/tor/torrc
echo "HiddenServicePort 80 127.0.0.1:\${PORT}" >> $HOME/etc/tor/torrc

# Use -f to be safe here.
$HOME/bin/tor -f $HOME/etc/tor/torrc &
exec \$*
EOF

chmod a+x ${BUILD_DIR}/bin/${RUN_COMMAND}

echo "Installed Tor successfully" | indent
